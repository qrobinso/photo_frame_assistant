{% extends "base.html" %}

{% block extra_head %}
<style>
    .settings-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 1rem;
    }
    
    /* Page Header */
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .page-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .back-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: white;
        border: 1px solid #e9ecef;
        color: #6c757d;
        text-decoration: none;
        transition: all 0.2s;
    }
    
    .back-btn:hover {
        background: #f8f9fa;
        color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .page-title-group {
        display: flex;
        flex-direction: column;
    }
    
    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #212529;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .page-subtitle {
        font-size: 0.85rem;
        color: #6c757d;
        margin: 0;
    }
    
    .header-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    /* Status Badge */
    .frame-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.75rem;
        border-radius: 2rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .frame-status-badge.online { background: #d4edda; color: #155724; }
    .frame-status-badge.sleeping { background: #fff3cd; color: #856404; }
    .frame-status-badge.offline { background: #f8d7da; color: #721c24; }
    
    .frame-status-badge .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
    }
    
    /* Quick Stats */
    .quick-stats {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        overflow-x: auto;
        padding: 0.25rem 0;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    
    .quick-stats::-webkit-scrollbar { display: none; }
    
    .stat-pill {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        padding: 0.5rem 0.875rem;
        border-radius: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        white-space: nowrap;
        flex-shrink: 0;
        font-size: 0.85rem;
    }
    
    .stat-pill i {
        color: #6c757d;
    }
    
    .stat-pill strong {
        color: #212529;
    }
    
    /* Settings Card */
    .settings-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        margin-bottom: 1rem;
        overflow: hidden;
    }
    
    .settings-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #f1f3f5;
        cursor: pointer;
        user-select: none;
    }
    
    .settings-card-header:hover {
        background: #fafbfc;
    }
    
    .settings-card-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 600;
        font-size: 1rem;
        color: #212529;
        margin: 0;
    }
    
    .settings-card-title i {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    
    .settings-card-title i.icon-display { background: #e7f1ff; color: #0d6efd; }
    .settings-card-title i.icon-image { background: #d4edda; color: #28a745; }
    .settings-card-title i.icon-layers { background: #fff3cd; color: #856404; }
    .settings-card-title i.icon-moon { background: #e2d9f3; color: #6f42c1; }
    .settings-card-title i.icon-info { background: #f8f9fa; color: #6c757d; }
    
    .settings-card-toggle {
        color: #adb5bd;
        transition: transform 0.2s;
    }
    
    .settings-card.collapsed .settings-card-toggle {
        transform: rotate(-90deg);
    }
    
    .settings-card.collapsed .settings-card-body {
        display: none;
    }
    
    .settings-card-body {
        padding: 1.25rem;
    }
    
    /* Form Styling */
    .form-section {
        margin-bottom: 1.5rem;
    }
    
    .form-section:last-child {
        margin-bottom: 0;
    }
    
    .form-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 0.75rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group:last-child {
        margin-bottom: 0;
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.375rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-label .badge {
        font-size: 0.65rem;
        font-weight: 500;
    }
    
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #e9ecef;
        padding: 0.625rem 0.875rem;
        transition: all 0.2s;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }
    
    .form-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.375rem;
    }
    
    /* Quick Buttons */
    .quick-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
        margin-top: 0.5rem;
    }
    
    .quick-btn {
        padding: 0.25rem 0.625rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid #e9ecef;
        background: white;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .quick-btn:hover {
        border-color: #0d6efd;
        color: #0d6efd;
        background: #f8f9ff;
    }
    
    /* Toggle Switch */
    .toggle-group {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f3f5;
    }
    
    .toggle-group:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .toggle-group:first-child {
        padding-top: 0;
    }
    
    .toggle-info {
        flex: 1;
    }
    
    .toggle-label {
        font-weight: 500;
        color: #212529;
        margin-bottom: 0.125rem;
    }
    
    .toggle-description {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .form-switch {
        padding-left: 2.5em;
    }
    
    .form-switch .form-check-input {
        width: 2.5em;
        height: 1.25em;
        cursor: pointer;
    }
    
    /* Slider */
    .slider-group {
        margin-bottom: 1rem;
    }
    
    .slider-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .slider-label {
        font-weight: 500;
        color: #495057;
    }
    
    .slider-value {
        font-weight: 600;
        color: #0d6efd;
        background: #e7f1ff;
        padding: 0.125rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.8rem;
    }
    
    .form-range {
        height: 6px;
    }
    
    .form-range::-webkit-slider-thumb {
        width: 18px;
        height: 18px;
    }
    
    /* Time Picker Grid */
    .time-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    /* Color Map */
    .color-map-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        min-height: 40px;
    }
    
    .color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    
    /* Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .info-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        color: #6c757d;
    }
    
    .info-content {
        flex: 1;
        min-width: 0;
    }
    
    .info-label {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .info-value {
        font-weight: 600;
        color: #212529;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Diagnostics Table */
    .diagnostics-table {
        font-size: 0.85rem;
    }
    
    .diagnostics-table th {
        font-weight: 500;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
    }
    
    .diagnostics-section-header {
        background: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    /* Preview Button */
    .preview-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .preview-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
    }
    
    /* Sticky Footer */
    .settings-footer {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 1rem;
        margin: 1.5rem -1rem -1rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        z-index: 10;
    }
    
    .footer-primary {
        display: flex;
        gap: 0.5rem;
    }
    
    .footer-secondary {
        display: flex;
        gap: 0.5rem;
    }
    
    /* Modal Improvements */
    .modal-content {
        border-radius: 16px;
        border: none;
    }
    
    .modal-header {
        border-bottom: 1px solid #f1f3f5;
        padding: 1.25rem 1.5rem;
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .frame-list-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.5rem;
    }
    
    .frame-list-item:hover {
        border-color: #0d6efd;
        background: #f8f9ff;
    }
    
    .frame-list-item:last-child {
        margin-bottom: 0;
    }
    
    /* Success Toast */
    .toast-notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        display: none;
        z-index: 1050;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .page-header-left {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .header-actions {
            justify-content: stretch;
        }
        
        .header-actions .btn {
            flex: 1;
        }
        
        .time-grid {
            grid-template-columns: 1fr;
        }
        
        .settings-footer {
            flex-direction: column;
        }
        
        .footer-primary, .footer-secondary {
            width: 100%;
        }
        
        .footer-primary .btn, .footer-secondary .btn {
            flex: 1;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-left">
            <a href="{{ url_for('manage_frames') }}" class="back-btn">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div class="page-title-group">
                <h1 class="page-title">
                    <i class="bi bi-sliders"></i>
                    {{ frame.name }}
                </h1>
                <p class="page-subtitle">Frame Settings & Configuration</p>
            </div>
        </div>
        <div class="header-actions">
            {% set status = frame.get_status(now) if frame.get_status else [0, 'offline'] %}
            {% if status[0] == 2 %}
            <span class="frame-status-badge online"><span class="dot"></span> Online</span>
            {% elif status[0] == 1 %}
            <span class="frame-status-badge sleeping"><span class="dot"></span> Sleeping</span>
            {% else %}
            <span class="frame-status-badge offline"><span class="dot"></span> Offline</span>
            {% endif %}
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-pill">
            <i class="bi bi-clock"></i>
            <strong>{{ frame.sleep_interval }}</strong> min interval
        </div>
        <div class="stat-pill">
            <i class="bi bi-phone{% if frame.orientation == 'landscape' %}-landscape{% endif %}"></i>
            <strong>{{ frame.orientation|title }}</strong>
        </div>
        {% if frame.last_wake_time %}
        <div class="stat-pill">
            <i class="bi bi-eye"></i>
            Last seen <strong>{{ ((now - frame.last_wake_time).total_seconds() / 60)|round|int }}m</strong> ago
        </div>
        {% endif %}
        {% if frame.sync_group %}
        <div class="stat-pill">
            <i class="bi bi-people-fill"></i>
            <strong>{{ frame.sync_group.name }}</strong>
        </div>
        {% endif %}
    </div>
    
    <form method="POST" id="settingsForm">
        <!-- Playlist Settings -->
        <div class="settings-card" id="playlistCard">
            <div class="settings-card-header" onclick="toggleCard('playlistCard')">
                <h2 class="settings-card-title">
                    <i class="bi bi-collection-play icon-display"></i>
                    Playlist
                </h2>
                <i class="bi bi-chevron-down settings-card-toggle"></i>
            </div>
            <div class="settings-card-body">
                <div class="form-group">
                    <label for="playlist_id" class="form-label">Current Playlist</label>
                    <div class="d-flex gap-2">
                        <select class="form-select" id="playlist_id" name="playlist_id">
                            {% for playlist in playlists %}
                            <option value="{{ playlist.id }}" {% if frame.playlist_id == playlist.id %}selected{% endif %}>
                                {{ playlist.name }} ({{ playlist.entries.count() }} photos)
                            </option>
                            {% endfor %}
                        </select>
                        {% if frame.playlist %}
                        <a href="{{ url_for('edit_custom_playlist', playlist_id=frame.playlist.id) }}" class="btn btn-outline-secondary" title="Edit playlist">
                            <i class="bi bi-pencil"></i>
                        </a>
                        {% endif %}
                    </div>
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i> 
                        Select which playlist this frame should display. Multiple frames can share the same playlist.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Display Settings -->
        <div class="settings-card" id="displayCard">
            <div class="settings-card-header" onclick="toggleCard('displayCard')">
                <h2 class="settings-card-title">
                    <i class="bi bi-display icon-display"></i>
                    Display Settings
                </h2>
                <i class="bi bi-chevron-down settings-card-toggle"></i>
            </div>
            <div class="settings-card-body">
                <div class="form-group">
                    <label for="name" class="form-label">Frame Name</label>
                    <input type="text" class="form-control" id="name" name="name" 
                           value="{{ frame.name }}" required placeholder="Living Room Frame">
                </div>
                
                <div class="form-group">
                    <label for="orientation" class="form-label">Display Orientation</label>
                    <select class="form-select" id="orientation" name="orientation">
                        <option value="landscape" {% if frame.orientation == 'landscape' %}selected{% endif %}>
                            <i class="bi bi-phone-landscape"></i> Landscape (Horizontal)
                        </option>
                        <option value="portrait" {% if frame.orientation == 'portrait' %}selected{% endif %}>
                            <i class="bi bi-phone"></i> Portrait (Vertical)
                        </option>
                    </select>
                </div>
                
                <div class="toggle-group" style="margin: 1rem 0;">
                    <div class="toggle-info">
                        <div class="toggle-label"><i class="bi bi-shuffle me-2"></i>Shuffle Photos</div>
                        <div class="toggle-description">Randomize the order of photos instead of playing in sequence</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="shuffle_enabled" name="shuffle_enabled"
                               {% if frame.shuffle_enabled %}checked{% endif %}>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sleep_interval" class="form-label">
                        Photo Change Interval
                        {% if frame.sync_group %}
                        <span class="badge bg-secondary">Controlled by group</span>
                        {% endif %}
                    </label>
                    {% if frame.sync_group %}
                        <input type="number" class="form-control" id="sleep_interval" 
                               value="{{ frame.sync_group.sleep_interval }}" disabled>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> This setting is controlled by sync group: <strong>{{ frame.sync_group.name }}</strong>
                        </div>
                    {% else %}
                        <input type="number" class="form-control" id="sleep_interval" 
                               name="sleep_interval" value="{{ frame.sleep_interval }}" 
                               min="0.5" step="0.5" required>
                        <div class="quick-buttons">
                            <button type="button" class="quick-btn" onclick="setSleepInterval(5)">5 min</button>
                            <button type="button" class="quick-btn" onclick="setSleepInterval(15)">15 min</button>
                            <button type="button" class="quick-btn" onclick="setSleepInterval(30)">30 min</button>
                            <button type="button" class="quick-btn" onclick="setSleepInterval(60)">1 hour</button>
                            <button type="button" class="quick-btn" onclick="setSleepInterval(180)">3 hours</button>
                            <button type="button" class="quick-btn" onclick="setSleepInterval(1440)">1 day</button>
                        </div>
                        
                        <div class="toggle-group" id="snapToHourGroup" style="margin-top: 1rem; {% if frame.sleep_interval < 60 %}display: none;{% endif %}">
                            <div class="toggle-info">
                                <div class="toggle-label"><i class="bi bi-clock me-2"></i>Snap to Top of Hour</div>
                                <div class="toggle-description">Change photos at clock hours (e.g., 1:00, 2:00) instead of relative intervals</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="snap_to_hour" name="snap_to_hour"
                                       {% if frame.snap_to_hour %}checked{% endif %}>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sleep Schedule -->
        <div class="settings-card" id="sleepCard">
            <div class="settings-card-header" onclick="toggleCard('sleepCard')">
                <h2 class="settings-card-title">
                    <i class="bi bi-moon-stars icon-moon"></i>
                    Sleep Schedule
                </h2>
                <i class="bi bi-chevron-down settings-card-toggle"></i>
            </div>
            <div class="settings-card-body">
                <div class="toggle-group">
                    <div class="toggle-info">
                        <div class="toggle-label">Enable Deep Sleep</div>
                        <div class="toggle-description">Frame won't wake up or change photos during sleep hours</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="deepSleepEnabled" name="deep_sleep_enabled"
                               {% if frame.deep_sleep_enabled %}checked{% endif %}>
                    </div>
                </div>
                
                <div class="deep-sleep-controls" {% if not frame.deep_sleep_enabled %}style="display: none;"{% endif %}>
                    <div class="form-section" style="margin-top: 1rem;">
                        <div class="time-grid">
                            <div class="form-group">
                                <label for="deepSleepStart" class="form-label">Sleep Starts</label>
                                <select class="form-select" id="deepSleepStart" name="deep_sleep_start">
                                    {% for hour in range(24) %}
                                        <option value="{{ hour }}" {% if frame.deep_sleep_start == hour %}selected{% endif %}>
                                            {{ '%02d:00'|format(hour) }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deepSleepEnd" class="form-label">Sleep Ends</label>
                                <select class="form-select" id="deepSleepEnd" name="deep_sleep_end">
                                    {% for hour in range(24) %}
                                        <option value="{{ hour }}" {% if frame.deep_sleep_end == hour %}selected{% endif %}>
                                            {{ '%02d:00'|format(hour) }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-clock"></i> Times are in {{ server_settings.timezone }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Image Adjustments -->
        <div class="settings-card" id="imageCard">
            <div class="settings-card-header" onclick="toggleCard('imageCard')">
                <h2 class="settings-card-title">
                    <i class="bi bi-sliders2 icon-image"></i>
                    Image Adjustments
                </h2>
                <i class="bi bi-chevron-down settings-card-toggle"></i>
            </div>
            <div class="settings-card-body">
                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Contrast</span>
                        <span class="slider-value" id="contrastValue">{{ frame.contrast_factor }}</span>
                    </div>
                    <input type="range" class="form-range" id="contrastFactor" name="contrast_factor" 
                           value="{{ frame.contrast_factor }}" step="0.1" min="0.5" max="2.0"
                           oninput="updateSliderValue('contrastValue', this.value)">
                    <div class="form-text">Adjust image contrast. Default: 1.0</div>
                </div>
                
                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Saturation</span>
                        <span class="slider-value" id="saturationValue">{{ frame.saturation }}%</span>
                    </div>
                    <input type="range" class="form-range" id="saturation" name="saturation" 
                           value="{{ frame.saturation }}" step="10" min="0" max="300"
                           oninput="updateSliderValue('saturationValue', this.value + '%')">
                    <div class="form-text">Adjust color intensity. Default: 100%</div>
                </div>
                
                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Hue Shift</span>
                        <span class="slider-value" id="blueValue">{{ frame.blue_adjustment }}</span>
                    </div>
                    <input type="range" class="form-range" id="blueAdjustment" name="blue_adjustment" 
                           value="{{ frame.blue_adjustment }}" step="1" min="0" max="20"
                           oninput="updateSliderValue('blueValue', this.value)">
                    <div class="form-text">Shift hue towards blue. Default: 0</div>
                </div>
                
                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Padding</span>
                        <span class="slider-value" id="paddingValue">{{ frame.padding }}px</span>
                    </div>
                    <input type="range" class="form-range" id="padding" name="padding" 
                           value="{{ frame.padding }}" step="1" min="0" max="50"
                           oninput="updateSliderValue('paddingValue', this.value + 'px')">
                    <div class="form-text">Add border padding around images. Default: 0px</div>
                </div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="colorMap" class="form-label">
                        Color Palette
                        <span class="badge bg-secondary" id="colorCount">{{ frame.color_map|length if frame.color_map else 0 }} colors</span>
                    </label>
                    <textarea class="form-control" id="colorMap" name="color_map" rows="3" 
                              placeholder="Enter hex colors (one per line)&#10;Example: #FF5733&#10;#3498DB"
                              oninput="updateColorCount()">{% if frame.color_map %}{{ frame.color_map|join('\n') }}{% endif %}</textarea>
                    <div class="form-text">Custom color palette for e-ink displays. Leave empty for automatic.</div>
                    <div class="color-map-preview" id="colorPreview"></div>
                </div>
                
                <div class="preview-section">
                    <button type="button" class="btn btn-outline-primary preview-btn" onclick="previewFinalImage()">
                        <i class="bi bi-eye"></i> Preview with Settings
                    </button>
                    <span class="text-muted small">See how photos will look on this frame</span>
                </div>
            </div>
        </div>
        
        <!-- Overlays -->
        <div class="settings-card" id="overlaysCard">
            <div class="settings-card-header" onclick="toggleCard('overlaysCard')">
                <h2 class="settings-card-title">
                    <i class="bi bi-layers icon-layers"></i>
                    Overlays
                </h2>
                <i class="bi bi-chevron-down settings-card-toggle"></i>
            </div>
            <div class="settings-card-body">
                <div class="toggle-group">
                    <div class="toggle-info">
                        <div class="toggle-label"><i class="bi bi-cloud-sun me-2"></i>Weather Information</div>
                        <div class="toggle-description">Show current weather on the frame</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="weatherOverlay" name="weather_overlay"
                               {% if frame.overlay_preferences %}
                                   {% set prefs = frame.overlay_preferences|from_json %}
                                   {% if prefs.weather %}checked{% endif %}
                               {% endif %}>
                    </div>
                </div>
                
                <div class="toggle-group">
                    <div class="toggle-info">
                        <div class="toggle-label"><i class="bi bi-info-circle me-2"></i>Photo Metadata</div>
                        <div class="toggle-description">Display date, location, and camera info</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="metadataOverlay" name="metadata_overlay"
                               {% if frame.overlay_preferences %}
                                   {% set prefs = frame.overlay_preferences|from_json %}
                                   {% if prefs.metadata %}checked{% endif %}
                               {% endif %}>
                    </div>
                </div>
                
                <div class="toggle-group">
                    <div class="toggle-info">
                        <div class="toggle-label"><i class="bi bi-qr-code me-2"></i>QR Code</div>
                        <div class="toggle-description">Display a QR code linking to this server</div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="qrcodeOverlay" name="qrcode_overlay"
                               {% if frame.overlay_preferences %}
                                   {% set prefs = frame.overlay_preferences|from_json %}
                                   {% if prefs.qrcode %}checked{% endif %}
                               {% endif %}>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status & Diagnostics -->
        <div class="settings-card collapsed" id="diagnosticsCard">
            <div class="settings-card-header" onclick="toggleCard('diagnosticsCard')">
                <h2 class="settings-card-title">
                    <i class="bi bi-activity icon-info"></i>
                    Status & Diagnostics
                </h2>
                <i class="bi bi-chevron-down settings-card-toggle"></i>
            </div>
            <div class="settings-card-body">
                <!-- Wake Info -->
                <div class="form-section">
                    <div class="form-section-title">Wake Schedule</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="info-content">
                                <div class="info-label">Last Wake</div>
                                <div class="info-value">
                                    {% if frame.last_wake_time %}
                                        {{ frame.last_wake_time.strftime('%H:%M:%S') }}
                                        <small class="text-muted">({{ ((now - frame.last_wake_time).total_seconds() / 60)|round|int }}m ago)</small>
                                    {% else %}
                                        Never
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="bi bi-alarm"></i>
                            </div>
                            <div class="info-content">
                                <div class="info-label">Next Wake</div>
                                <div class="info-value">
                                    {% if frame.next_wake_time %}
                                        {{ frame.next_wake_time.strftime('%H:%M:%S') }}
                                        <small class="text-muted">(in {{ ((frame.next_wake_time - now).total_seconds() / 60)|round|int }}m)</small>
                                    {% else %}
                                        Not scheduled
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Diagnostics -->
                {% if frame.diagnostics %}
                <div class="form-section" style="margin-top: 1.5rem;">
                    <div class="form-section-title">Device Diagnostics</div>
                    {% if frame.diagnostics is string %}
                        {% set diag = frame.diagnostics|from_json %}
                    {% else %}
                        {% set diag = frame.diagnostics %}
                    {% endif %}
                    
                    {% if diag is mapping %}
                    <div class="table-responsive">
                        <table class="table table-sm diagnostics-table">
                            <tbody>
                                {% for key, value in diag.items() recursive %}
                                    {% if value is mapping %}
                                        <tr class="diagnostics-section-header">
                                            <td colspan="2">{{ key.replace('_', ' ')|title }}</td>
                                        </tr>
                                        {{ loop(value.items()) }}
                                    {% else %}
                                        <tr>
                                            <td class="text-capitalize" style="width: 40%;">{{ key.replace('_', ' ') }}</td>
                                            <td>
                                                {% if value is boolean %}
                                                    <span class="badge {% if value %}bg-success{% else %}bg-danger{% endif %}">
                                                        {{ 'Yes' if value else 'No' }}
                                                    </span>
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Invalid diagnostics format</p>
                    {% endif %}
                </div>
                {% else %}
                <div class="form-section" style="margin-top: 1.5rem;">
                    <div class="form-section-title">Device Diagnostics</div>
                    <p class="text-muted mb-0">No diagnostic information available. This will populate when the frame connects.</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Sticky Footer -->
        <div class="settings-footer">
            <div class="footer-primary">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg"></i> Save Changes
                </button>
                <a href="{{ url_for('edit_playlist', frame_id=frame.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-collection-play"></i> Edit Playlist
                </a>
            </div>
            <div class="footer-secondary">
                <button type="button" class="btn btn-outline-secondary" onclick="showImportModal()">
                    <i class="bi bi-download"></i> Import
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="confirmDeleteFrame('{{ frame.id }}')">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-download me-2"></i>Import Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Copy all settings and playlists from another frame:</p>
                <div class="frame-list">
                    {% for other_frame in frames %}
                        {% if other_frame.id != frame.id %}
                        <div class="frame-list-item" onclick="confirmImport('{{ other_frame.id }}')">
                            <i class="bi bi-display"></i>
                            <div>
                                <div class="fw-semibold">{{ other_frame.name or other_frame.id }}</div>
                                <small class="text-muted">{{ other_frame.sleep_interval }} min interval</small>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Confirmation Modal -->
<div class="modal fade" id="importConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Import</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>This will overwrite all current settings and playlists. Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importSettings()">Import Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteFrameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Delete Frame</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ frame.name }}</strong>?</p>
                <p class="text-muted mb-0">This will permanently remove all playlists and settings associated with this frame.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteFrame()">Delete Frame</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div id="toastNotification" class="toast-notification"></div>
{% endblock %}

{% block extra_scripts %}
<script>
let frameToDelete = null;
let importModal, importConfirmModal;
let sourceFrameId;

document.addEventListener('DOMContentLoaded', function() {
    importModal = new bootstrap.Modal(document.getElementById('importModal'));
    importConfirmModal = new bootstrap.Modal(document.getElementById('importConfirmModal'));
    
    // Initialize color preview
    updateColorCount();
    updateColorPreview();
    
    // Deep sleep toggle
    document.getElementById('deepSleepEnabled').addEventListener('change', function() {
        const controls = document.querySelector('.deep-sleep-controls');
        controls.style.display = this.checked ? 'block' : 'none';
    });
    
    // Sleep interval change - update snap-to-hour visibility
    const sleepIntervalInput = document.getElementById('sleep_interval');
    if (sleepIntervalInput) {
        sleepIntervalInput.addEventListener('input', updateSnapToHourVisibility);
        // Initial visibility check on page load
        updateSnapToHourVisibility();
    }
});

// Card toggle
function toggleCard(cardId) {
    const card = document.getElementById(cardId);
    card.classList.toggle('collapsed');
}

// Slider value updates
function updateSliderValue(elementId, value) {
    document.getElementById(elementId).textContent = value;
}

// Sleep interval quick buttons
function setSleepInterval(minutes) {
    document.getElementById('sleep_interval').value = minutes;
    updateSnapToHourVisibility();
}

// Show/hide snap-to-hour toggle based on interval value
function updateSnapToHourVisibility() {
    const intervalInput = document.getElementById('sleep_interval');
    const snapGroup = document.getElementById('snapToHourGroup');
    if (intervalInput && snapGroup) {
        const interval = parseFloat(intervalInput.value) || 0;
        snapGroup.style.display = interval >= 60 ? '' : 'none';
    }
}

// Color map functions
function updateColorCount() {
    const colorMap = document.getElementById('colorMap').value;
    const colors = colorMap.split('\n').filter(line => line.trim() !== '');
    document.getElementById('colorCount').textContent = colors.length + ' colors';
    updateColorPreview();
}

function updateColorPreview() {
    const colorMap = document.getElementById('colorMap').value;
    const colors = colorMap.split('\n').filter(line => line.trim() !== '');
    const preview = document.getElementById('colorPreview');
    
    if (colors.length === 0) {
        preview.innerHTML = '<span class="text-muted small">No colors defined</span>';
        return;
    }
    
    preview.innerHTML = colors.map(color => {
        const trimmed = color.trim();
        if (/^#[0-9A-Fa-f]{6}$/.test(trimmed)) {
            return `<div class="color-swatch" style="background-color: ${trimmed};" title="${trimmed}"></div>`;
        }
        return '';
    }).join('');
}

// Preview
function previewFinalImage() {
    const params = new URLSearchParams({
        preview: 'true',
        contrast_factor: document.getElementById('contrastFactor').value,
        saturation: document.getElementById('saturation').value,
        blue_adjustment: document.getElementById('blueAdjustment').value,
        padding: document.getElementById('padding').value,
        weather: document.getElementById('weatherOverlay').checked,
        metadata: document.getElementById('metadataOverlay').checked,
        qrcode: document.getElementById('qrcodeOverlay').checked
    });
    window.open(`/test/overlay/{{ frame.id }}?${params}`, '_blank');
}

// Import functions
function showImportModal() {
    importModal.show();
}

function confirmImport(frameId) {
    sourceFrameId = frameId;
    importModal.hide();
    importConfirmModal.show();
}

function importSettings() {
    fetch(`/api/frames/{{ frame.id }}/import-settings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ source_frame_id: sourceFrameId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Settings imported successfully!');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => showToast('Error importing settings', 'error'));
}

// Delete functions
function confirmDeleteFrame(frameId) {
    frameToDelete = frameId;
    new bootstrap.Modal(document.getElementById('deleteFrameModal')).show();
}

function deleteFrame() {
    if (!frameToDelete) return;
    
    fetch(`/api/frames/${frameToDelete}/delete`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = "{{ url_for('manage_frames') }}";
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => showToast('Error deleting frame', 'error'));
}

// Form validation
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    const enabled = document.getElementById('deepSleepEnabled').checked;
    if (enabled) {
        const start = parseInt(document.getElementById('deepSleepStart').value);
        const end = parseInt(document.getElementById('deepSleepEnd').value);
        if (start === end) {
            e.preventDefault();
            showToast('Sleep start and end times cannot be the same', 'error');
        }
    }
});

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toastNotification');
    toast.textContent = message;
    toast.style.background = type === 'error' ? '#dc3545' : '#28a745';
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 3000);
}
</script>
{% endblock %}
